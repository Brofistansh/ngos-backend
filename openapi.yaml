openapi: 3.1.0
info:
  title: NGOs Backend API
  version: "1.0.0"
  description: |
    Full OpenAPI 3.1 specification for the NGOs backend.
    Includes Auth, NGOs, Centers, Users, Attendance, Students,
    Donations, Reports, role rules, and x-api-key security.

servers:
  - url: http://localhost:4000
    description: Local dev
  - url: https://ngos-backend.onrender.com
    description: Production (Render)

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

    xApiKey:
      type: apiKey
      in: header
      name: x-api-key

  schemas:
    Error:
      type: object
      properties:
        message:
          type: string

    AuthLoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    AuthLoginResponse:
      type: object
      properties:
        message: { type: string }
        token: { type: string }
        access_token: { type: string }
        refresh_token: { type: string }

    RefreshRequest:
      type: object
      required: [refresh_token]
      properties:
        refresh_token: { type: string }

    RefreshResponse:
      type: object
      properties:
        access_token: { type: string }
        refresh_token: { type: string }

    RequestPasswordReset:
      type: object
      required: [email]
      properties:
        email: { type: string }

    ResetPassword:
      type: object
      required: [uid, token, new_password]
      properties:
        uid: { type: string, format: uuid }
        token: { type: string }
        new_password: { type: string }

    NGO:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        registration_number: { type: string }
        contact_email: { type: string, format: email }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    CreateNGO:
      type: object
      required: [name, registration_number, contact_email]
      properties:
        name: { type: string }
        registration_number: { type: string }
        contact_email: { type: string }

    Center:
      type: object
      properties:
        id: { type: string, format: uuid }
        ngo_id: { type: string, format: uuid }
        name: { type: string }
        contact_phone: { type: string }
        timezone: { type: string }
        createdAt: { type: string, format: date-time }

    CreateCenter:
      type: object
      required: [name, contact_phone, timezone]
      properties:
        name: { type: string }
        contact_phone: { type: string }
        timezone: { type: string }

    User:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        email: { type: string }
        role: { type: string }
        ngo_id: { type: string, nullable: true }
        center_id: { type: string, nullable: true }

    CreateUser:
      type: object
      required: [name, email, password, role]
      properties:
        name: { type: string }
        email: { type: string }
        password: { type: string }
        role:
          type: string
          enum:
            - super_admin
            - ngo_admin
            - ngo_manager
            - center_manager
            - teacher
            - donor_analyst
            - teacher_assistant
            - teacher_volunteer
            - teacher_intern
            - teacher_substitute
        ngo_id: { type: string }
        center_id: { type: string }

    AttendanceMark:
      type: object
      required: [user_id, status]
      properties:
        user_id: { type: string }
        status:
          type: string
          enum: [present, absent, late, excused]

    Student:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        age: { type: integer }
        gender: { type: string }
        enrollment_status: { type: string }
        ngo_id: { type: string }
        center_id: { type: string }
        assigned_teacher_id: { type: string }

    CreateStudent:
      type: object
      required: [name, age, gender, ngo_id, center_id]
      properties:
        name: { type: string }
        age: { type: integer }
        gender: { type: string }
        ngo_id: { type: string }
        center_id: { type: string }
        assigned_teacher_id: { type: string }

    StudentAttendanceMark:
      type: object
      required: [student_id, status]
      properties:
        student_id: { type: string }
        status:
          type: string
          enum: [present, absent, late, excused]

    Donor:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        email: { type: string }
        phone: { type: string }
        address: { type: string }
        notes: { type: string }
        ngo_id: { type: string }
        createdAt: { type: string }

    CreateDonor:
      type: object
      required: [name]
      properties:
        name: { type: string }
        email: { type: string }
        phone: { type: string }
        address: { type: string }
        notes: { type: string }

    Donation:
      type: object
      properties:
        id: { type: string }
        donor_id: { type: string }
        ngo_id: { type: string }
        center_id: { type: string }
        amount: { type: number }
        currency: { type: string }
        date: { type: string }
        method: { type: string }
        purpose: { type: string }
        receipt_number: { type: string }
        status: { type: string }
        createdAt: { type: string }

    CreateDonation:
      type: object
      required: [donor_id, amount, currency, date, method]
      properties:
        donor_id: { type: string }
        ngo_id: { type: string }
        center_id: { type: string }
        amount: { type: number }
        currency: { type: string }
        date: { type: string }
        method: { type: string }
        purpose: { type: string }

    ReportDailySummary:
      type: object
      properties:
        center_id: { type: string }
        date: { type: string }
        teachers:
          type: object
        students:
          type: object

paths:

  /:
    get:
      summary: Root - health message
      security:
        - xApiKey: []  # no JWT needed
      responses:
        "200":
          description: OK
          content:
            text/plain:
              schema:
                type: string

  /health:
    get:
      summary: Health check
      security:
        - xApiKey: []
      responses:
        "200":
          description: ok

  /auth/login:
    post:
      tags: [Auth]
      summary: Login user
      security:
        - xApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthLoginRequest'
      responses:
        "200":
          description: Login success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthLoginResponse'

  /auth/refresh:
    post:
      tags: [Auth]
      summary: Refresh JWT using refresh token
      security:
        - xApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefreshResponse'

  /auth/request-password-reset:
    post:
      tags: [Auth]
      summary: Send password reset email
      security:
        - xApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RequestPasswordReset'
      responses:
        "200":
          description: Sent

  /auth/reset-password:
    post:
      tags: [Auth]
      summary: Reset password
      security:
        - xApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPassword'
      responses:
        "200":
          description: Reset OK

  /ngos:
    post:
      tags: [NGOs]
      summary: Create NGO
      security:
        - bearerAuth: []
        - xApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateNGO'
      responses:
        "200":
          description: NGO created

  /ngos/{ngoId}/centers:
    post:
      tags: [Centers]
      summary: Create a center
      security:
        - bearerAuth: []
        - xApiKey: []
      parameters:
        - name: ngoId
          in: path
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCenter'
      responses:
        "200":
          description: Center created

  /users:
    post:
      tags: [Users]
      summary: Create new user
      security:
        - bearerAuth: []
        - xApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUser'
      responses:
        "200":
          description: User created

  /attendance/mark:
    post:
      tags: [Attendance]
      summary: Mark staff attendance
      security:
        - bearerAuth: []
        - xApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AttendanceMark'
      responses:
        "200":
          description: Marked

  /student-attendance/mark:
    post:
      tags: [Student Attendance]
      summary: Mark student attendance
      security:
        - bearerAuth: []
        - xApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StudentAttendanceMark'
      responses:
        "200":
          description: Marked

  /students:
    post:
      tags: [Students]
      summary: Create student
      security:
        - bearerAuth: []
        - xApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateStudent'
      responses:
        "200":
          description: Student created

  /donors:
    post:
      tags: [Donations]
      summary: Create donor
      security:
        - bearerAuth: []
        - xApiKey: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateDonor'
      responses:
        "200":
          description: Donor created

  /donations:
    post:
      tags: [Donations]
      summary: Record donation
      security:
        - bearerAuth: []
        - xApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateDonation'
      responses:
        "200":
          description: Donation recorded
